(()=>{function e(e,t){return 1===e.length?"month"===t?`0${parseInt(e)+1}`:`0${e}`:"month"===t?parseInt(e)+1:e}function t(t){return`${e(t.getDate().toString(),"day")}/${e(t.getMonth().toString(),"month")}/${t.getFullYear()}`}function n(e,t){let n=new Date(e);return n.setDate(e.getDate()+t),n}function a(e,t){let n,a,s,i=[];return[e,t].forEach((e=>{if(void 0===e)return i;n=1===e.getHours().toString().length?`0${e.getHours()}`:e.getHours(),a=1===e.getMinutes().toString().length?`0${e.getMinutes()}`:e.getMinutes(),s=`${n}:${a}`,i.push(s)})),i}async function s(e){let t,n=await executeAction("getserviceduration",null,{service_id:e});return""==e&&(e=1),t=(e=parseInt(e))>0?n[0].duration:30,t}async function i(){let e=await executeAction("getsaasagenda"),t={domingo:0,"segunda-feira":1,"terça-feira":2,"quarta-feira":3,"quinta-feira":4,"sexta-feira":5,sábado:6};return e.forEach((e=>{e.weekday in t&&(e.weekday=t[e.weekday])})),e}async function o(e){let n=new Date;n.setDate(n.getDate()+e);let a=n.toJSON().slice(0,10).replace(/-/g,"-"),s={};return(await executeAction("getallschedules",null,{end_date:a},{end_date:a})).forEach((e=>{let n={},a="",i=e.physiotherapist_id,o=e.duration;if("Bloqueio de Horário"===e.type)n={start:e.lock_start_hour.substring(0,5),end:e.lock_end_hour.substring(0,5)},a=t(new Date(e.lock_date));else{let s=e.schedule.slice(0,-1).split("T"),i=new Date(s);i.setMinutes(i.getMinutes()+o);let l=1===i.getHours().toString().length?`0${i.getHours()}`:i.getHours(),u=1===i.getMinutes().toString().length?`0${i.getMinutes()}`:i.getMinutes();n={start:s[1].substring(0,5),end:`${l}:${u}`},a=t(i)}Object.keys(s).includes(i.toString())?(Object.keys(s[i]).includes(a)||(s[i][a]=[]),s[i][a].push(n)):s[i]={[a]:[n]}})),s}function l(e,t,n,s){let i=n.sort(((e,t)=>e.start>t.start?1:-1)),o=[[e,e]],l=[];return i.forEach((n=>{Date.parse(`01/01/2011 ${e}`)<=Date.parse(`01/01/2011 ${n.start}`)<Date.parse(`01/01/2011  ${t}`)&&o.push([n.start,n.end])})),o.push([t,t]),o.forEach(((e,t)=>{if(t>0&&new Date(`01/01/2011 ${o[t][0]}`)-new Date(`01/01/2011 ${o[t-1][1]}`)>0){let e=new Date(`01/01/2011 ${o[t-1][1]}`),n=structuredClone(e),i=Math.abs(new Date(`01/01/2011 ${o[t][0]}`)-new Date(`01/01/2011 ${o[t-1][1]}`))/36e5*60,u=new Date(n.setMinutes(n.getMinutes()+i));i>=s&&l.push(a(e,u))}})),l}!function(){let e=new Date;components.current_date.value=e.toJSON().slice(0,10)}(),async function(){let e=await async function(){let e=await s(components.service__service_id.value),u=await i(),r=await o(20),c=await function(e,a,s,i){let o=new Date,u=[],r=[];for(let e=0;e<20;e++)u.push(n(o,e));for(dateIndex in u){let e=u[dateIndex],n=e.getDay(),o=t(e),c=a.filter((e=>e.weekday==n));for(agendaIndex in c){let e=[];c[agendaIndex].physiotherapist_id in s&&o in s[c[agendaIndex].physiotherapist_id]&&(e=s[c[agendaIndex].physiotherapist_id][o]);let t=l(c[agendaIndex].start_hour,c[agendaIndex].end_hour,e,i);if(t){let e={date:o,free_slots:t};r.push(e)}}}return r}(0,u,r,e),d=await function(e,t){let n={};for(availableDateIndex in e){let s=[];for(freeSlotsIndex in e[availableDateIndex].free_slots){let i=new Date(`01/01/2011 ${e[availableDateIndex].free_slots[freeSlotsIndex][0]}`),o=new Date(`01/01/2011 ${e[availableDateIndex].free_slots[freeSlotsIndex][1]}`),l=i;for(;l<o;){let e,n=["00","15","30","45"],i=1===l.getMinutes().toString().length?`0${l.getMinutes()}`:`${l.getMinutes()}`;if(n.includes(i)){let e=structuredClone(l);if(e.setMinutes(e.getMinutes()+t),!(e<=o))break;s.includes(l)||(s=s.concat(a(l))),l=new Date(l.setMinutes(l.getMinutes()+15))}else{n.push(i),n.sort();let t=n.indexOf(i);e=i>"44"?60-parseInt(n[t]):parseInt(n[t+1])-parseInt(n[t]),l=new Date(l.setMinutes(l.getMinutes()+e))}}s.sort(),n[e[availableDateIndex].date]=s}}return n}(c,e),h=new Date;h.setMinutes(h.getMinutes()+120);let p=t(h),g=`${1===h.getHours().toString().length?`0${h.getHours()}`:h.getHours()}:${1===h.getMinutes().toString().length?`0${h.getMinutes()}`:h.getMinutes()}`,_=[];if(p in d){for(availableTimeIndex in d[p])d[p][availableTimeIndex]>g&&_.push(d[p][availableTimeIndex]);_.length>0?d[p]=_:d.pop(p)}return d}(),u=function(e){return Object.keys(e)}(e),r=[];u.forEach((e=>{r.push({label:e,value:e})})),components.schedule__schedule_date2.options=r,components.schedule__schedule_date2.onChange((()=>{let t=components.schedule__schedule_date2.value;if(t){let n=function(e,t){return e[t]}(e,t),a=[];n.forEach((e=>{a=a.concat({label:e,value:e})})),components.schedule__schedule_hour.options=a,components.schedule__schedule_hour.value=""}else components.schedule__schedule_hour.value=""})),components.schedule__schedule_hour.onChange((async()=>{let e=components.schedule__schedule_date2.value,t=components.schedule__schedule_hour.value;components.schedule__schedule.value=e+" "+t;let n=await async function(e){let t=await s(components.service__service_id.value),n=`${e.split(" ")[0].split("/")[1]}/${e.split(" ")[0].split("/")[0]}/${e.split(" ")[0].split("/")[2]}`,a=new Date(`${n} ${e.split(" ")[1]}`),u=structuredClone(a),r=await o(20),c=a.getDay(),d=await i(),h=[],p=e.split(" ")[0],g=a,_=new Date(u.setMinutes(u.getMinutes()+t));d.forEach((e=>{e.weekday===c&&h.push(e)}));let f=[];h.forEach((e=>{let a=[];e.physiotherapist_id in r&&p in r[e.physiotherapist_id]&&(a=r[e.physiotherapist_id][p]),l(e.start_hour,e.end_hour,a,t).forEach((t=>{let a=new Date(`${n} ${t[0]}`),s=new Date(`${n} ${t[1]}`);a<=g&&s>=_&&(f.includes(e.physiotherapist_id)||(f=f.concat(e.physiotherapist_id)))}))}));let w=f[Math.floor(Math.random()*f.length)],$=await executeAction("getselectphysiosaasinfos",null,{selectRandomPhysio:w});return{chosenPhysioId:w.toString(),name:`${$[0].first_name} ${$[0].last_name}`,email:$[0].email}}(components.schedule__schedule.value);components.schedule__physiotherapist_id.value=n.chosenPhysioId,components.name__physiotherapist_name.value=n.name,components.name__physiotherapist_email.value=n.email}))}()})();